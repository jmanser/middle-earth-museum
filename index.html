<!--

           Hello curious Progger!

           Have fun exploring the code behind this little game. Gemini did most of it and did a pretty good job.

           It's pure HTML/CSS/JS. No frameworks, no libraries!

           It took 15-20 rounds of increasingly specific prompting, but the Gemini canvas feature made it super easy
           to debug as we went.

           Then I just tweaked some of the CSS for aesthetics, configured the levels, added a welcome message, etc.
           
           
                                                                                                    
                                                                                                    
                                          .              .                                          
                                    .------:.          .:------. .                                  
                                 ..--:....:--:        .--:....:--..                                 
                                ..--.:..+%+.:-.      .--.+%+....--..                                
                                .:-::*..*%%-:----------:-%%*..+::-:.                                
                                ..--.+%%%%*.:----------:.*%%%%*.--..                                
                                ..:--.:--:.--------------.:--:.--:.                                 
                               ..---------------------------------:.                                
                              .:------------------------------------.                               
                             .:--------------------------------------.                              
                             .:--------------------------------------.                              
                             .:--------------------------------------.                              
                             .:-----==------------------------==-----.                              
                              .-=-----==------+-----=------===----=-.                               
                               ..-=------==================------=:.                                
                                ..:===-----------------------===:..                                 
                                   ..=====---------------======:                                    
                                   .=+++===================++++=.                                   
                                   -++++=-----:::::::------=++++-.                                  
                                  .=+++=----...........:----=++++.                                  
                                 .-+++=---:..-.:::::::...:---=+++-.                                 
                         ..----:..=++=---:.:::.::-+:::::..:---=++=..::---..                         
                         :-------==++=--:..::::---::-=:::.:---=++==-------:                         
                         ------===+++=--.::.:::-:::--:.....:--==++===------                         
                         :---=====+++=--....::-:...........:--==++=====---:                         
                         .---=====+++=--.:::::+-::.:::.....:--=+++=====---.                         
                         ..---=====++=--:..::::---:---::..:---=++=====---..                         
                           .---====+++=--:....::-::--:-::.---=+++====---.                           
                            .:--====+++=--::...::::::...:---=+++====--:.                            
                           .:---=====+++=----:.......::----=+++=====---:.                           
                          .---========+++++==----------==+++++========---.                          
                         .:--==========+++==++--------++==+++==========--:.                         
                         .............=+-=+-....::::....-+=-+=.............                         
                                     :=+::==.          .=+::+=:                                     
                                                             ..                                     
                                                                                                    
                                                                                                    
                                                                                                    

-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Middle Earth Museum</title>
    <style>
        /* --- RESET & BASE STYLES --- */
        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; }
        body {
            margin: 0;
            padding: 0;
            background-color: #f4e4bc;
            font-family: 'Courier New', Courier, monospace;
            color: #3e3e3e;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        /* --- UI ELEMENTS --- */
        header {
            text-align: center;
            margin-bottom: 0.5rem;
        }
        h1 {
            margin-top: 1rem;
            font-size: 1.4rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-bottom: 2px solid #3e3e3e;
            padding-bottom: 0.5rem;
            margin-bottom: 0.2rem;
        }
        .subtitle {
            font-size: 0.8rem;
            font-style: italic;
        }

        /* --- TOOLBAR --- */
        #toolbar {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            background: #fff;
            padding: 0.5rem;
            border: 2px solid #3e3e3e;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.1);
            z-index: 2000;
        }
        .tool-btn {
            padding: 8px 16px;
            border: 2px solid #3e3e3e;
            background: #f4e4bc;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.1s;
        }
        .tool-btn.active {
            background: #3e3e3e;
            color: #f4e4bc;
            transform: translateY(2px);
        }
        .controls-hint {
            font-size: 0.7rem;
            color: #666;
            margin-left: 1rem;
            display: flex;
            align-items: center;
        }

        /* --- GAME CONTAINER --- */
        #game-area {
            display: flex;
            width: 95vw;
            max-width: 1100px;
            height: 70vh;
            border: 4px double #3e3e3e;
            background: #fff;
            position: relative;
            box-shadow: 10px 10px 0px rgba(0,0,0,0.1);
        }

        /* --- LEFT: EXCAVATION SITE (DIRT) --- */
        #dig-site {
            width: 45%;
            position: relative;
            border-right: 2px dashed #3e3e3e;
            overflow: hidden;
            background-color: #cba076; 
            background-image: radial-gradient(#b08d66 15%, transparent 16%);
            background-size: 20px 20px;
            z-index: 1; /* Low base z-index */
        }
        
        /* The Canvas sits ON TOP of the bones initially */
        #dirt-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 50;
            cursor: crosshair;
            touch-action: none;
        }
        
        /* When HAND tool is active, pass clicks through */
        #dig-site.tool-hand #dirt-canvas {
            pointer-events: none;
        }

        .label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #3e3e3e;
            color: #f4e4bc;
            padding: 4px 8px;
            font-size: 0.7rem;
            font-weight: bold;
            pointer-events: none;
            z-index: 200;
        }

        /* --- RIGHT: MUSEUM MOUNT (PAPER) --- */
        #museum-mount {
            width: 55%;
            background-color: #fdfbf7;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            z-index: 1;
        }
        #museum-mount::before {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(#e5e5e5 1px, transparent 1px), linear-gradient(90deg, #e5e5e5 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: 0;
        }

        /* --- THE BONES --- */
        .bone {
            position: absolute;
            cursor: grab;
            filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.2));
            transition: transform 0.1s linear; 
            z-index: 10;
            width: 100px; 
            touch-action: none;
            will-change: transform, left, top;
        }
        
        #game-area > .bone { z-index: 100; }

        .bone:active {
            cursor: grabbing;
            z-index: 999 !important;
            transform: scale(1.05);
            filter: drop-shadow(4px 4px 0px rgba(0,0,0,0.2));
        }
        
        .bone svg {
            width: 100%;
            height: 100%;
            fill: #fffbf0; 
            stroke: #2c2c2c; 
            stroke-width: 1.5px;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        #dig-site.tool-brush .bone { cursor: default; }

        /* --- SLOTS --- */
        .bone-slot {
            position: absolute;
            opacity: 0.15;
            pointer-events: none;
            z-index: 1;
        }
        .bone-slot svg {
            fill: #000;
            stroke: none;
        }

        /* --- MODAL (Museum Case) --- */
        #plaque-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 3000;
            perspective: 1000px;
        }
        #museum-case {
            background: #222;
            color: #fff;
            width: 90%;
            max-width: 600px;
            max-height: 95vh;
            border: 10px solid #111;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        #display-window {
            height: 300px;
            background: linear-gradient(to bottom, #333, #111);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            border-bottom: 5px solid #111;
        }
        #display-window::after {
            content: "";
            position: absolute;
            top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(0,0,0,0.5) 60%);
            pointer-events: none;
        }
        #creature-image {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover;
            opacity: 0.4;
            filter: grayscale(0.5);
            z-index: 0;
        }
        #skeleton-3d-container {
            position: relative;
            width: 200px;
            height: 200px;
            transform-style: preserve-3d;
            animation: spin 8s infinite linear;
            z-index: 10;
        }
        @keyframes spin {
            from { transform: rotateY(0deg); }
            to { transform: rotateY(360deg); }
        }
        .modal-bone {
            position: absolute;
            pointer-events: none;
        }
        .modal-bone svg {
            fill: #fffbf0;
            stroke: #2c2c2c;
            stroke-width: 1px;
            filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.5));
        }
        #plaque-info {
            background: #fff;
            color: #3e3e3e;
            padding: 1.5rem;
            text-align: center;
            font-family: 'Times New Roman', Times, serif;
        }
        #plaque-title {
            font-size: 1.8rem;
            margin: 0 0 0.5rem 0;
            color: #8b0000;
            font-style: italic;
            border-bottom: 2px solid #ccc;
            padding-bottom: 0.5rem;
            display: inline-block;
        }
        #plaque-desc {
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }
        .stat-block {
            border-top: 1px solid #ccc;
            padding-top: 1rem;
            display: flex;
            justify-content: space-around;
            font-size: 0.8rem;
            font-weight: bold;
            font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase;
        }
        .modal-btn {
            margin-top: 1.5rem;
            background: #3e3e3e;
            color: white;
            border: none;
            padding: 12px 24px;
            font-family: 'Courier New', Courier, monospace;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            width: 100%;
        }
        /* Welcome message */
        #welcome-modal {
            display: flex;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            justify-content: center;
            align-items: center;
            z-index: 5000;
        }
        #welcome-modal #museum-case {
            min-height: auto;
            max-width: 500px;
        }
        .modal-btn:hover { background: #555; }
        .confetti {
            position: absolute;
            width: 10px; height: 10px;
            background-color: #f00;
            animation: fall linear forwards;
            z-index: 4000;
            pointer-events: none;
        }
        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); }
        }

    </style>
</head>
<body>

    <header>
        <h1>Middle Earth Museum of Natural History</h1>
        <div class="subtitle" id="level-subtitle">Excavation Site: The Lonely Mountain</div>
    </header>

    <div id="toolbar">
        <button class="tool-btn active" id="btn-brush" onclick="setTool('brush')">
            ⛏️ Brush
        </button>
        <button class="tool-btn" id="btn-hand" onclick="setTool('hand')">
            ✋ Hand
        </button>
        <div class="controls-hint">
            <span>While Dragging: Use <b>A / D</b> or <b>Scroll</b> to Rotate</span>
        </div>
    </div>

    <div id="game-area">
        <!-- LEFT: THE DIRT -->
        <div id="dig-site" class="tool-brush">
            <div class="label">EXCAVATION ZONE</div>
        </div>

        <!-- RIGHT: THE MOUNT -->
        <div id="museum-mount">
            <div class="label">ASSEMBLY MOUNT</div>
        </div>
    </div>
    <!-- Welcome plaque -->
    <div id="welcome-modal">
        <div id="museum-case">
            <div id="display-window" style="height: 100px;">
               <div style="color: #f4e4bc; font-size: 3rem; opacity: 0.5;">⚒️</div>
            </div>     
            <div id="plaque-info">
                <h2 id="plaque-title" style="font-size: 1.5rem;">Middle Earth Excavation Mission</h2>
                <p id="plaque-desc">
                    Welcome, Dr. Garretty! We have detected ancient signatures beneath the (middle) earth and need your help excavating them.
                    <br><br>
                    <strong>MISSION PROTOCOLS:</strong>
                </p>
                <div style="text-align: left; margin: 0 auto 1.5rem auto; display: inline-block; font-family: 'Courier New', Courier, monospace; font-size: 0.9rem; color: #555;">
                    1. Select ⛏️ <b>BRUSH</b> to clear dirt.<br>
                    2. Select ✋ <b>HAND</b> to drag bones.<br>
                    3. Press <b>A / D</b> to rotate.<br>
                    4. Match bones to the assembly mount so the skeletons can be displayed in the Middle Earth Museum of Natural History.
                </div>
                <button class="modal-btn" onclick="closeWelcome()">BEGIN EXCAVATION!</button>
            </div>
        </div>
    </div>
    <!-- PLAQUE/REWARD -->
    <div id="plaque-modal">
        <div id="museum-case">
            <div id="display-window">
                <img id="creature-image" src="" alt="Creature Artist Rendition">
                <div id="skeleton-3d-container"></div>
            </div>
            
            <div id="plaque-info">
                <h2 id="plaque-title">Specimen Name</h2>
                <p id="plaque-desc">Description goes here.</p>
                <div class="stat-block" id="plaque-stats"></div>
                <button class="modal-btn" id="next-level-btn" onclick="nextLevel()">Proceed to Next Dig Site</button>
            </div>
        </div>
    </div>

    <script>
        // --- LEVELS ---
        const levels = [
            {
                name: "Smaugus terribilis",
                location: "Excavation Site: Erebor (The Lonely Mountain)",
                desc: "Recovered from the treasure hoards of Erebor. The elongated skull features prominent brow horns and a heavy lower mandible suited for crushing dwarf-forged armor.",
                stats: "<span>ERA: Third Age</span><span>TYPE: Dragon</span>",
                imgUrl: "https://miro.medium.com/v2/resize:fit:5400/1*fvuGyLK3Z1Rn3Ha1svXpNQ.jpeg",
                parts: [
                    // Head: Complex skull with horns and jaw
                    { id: 's-head', path: 'M10,40 L5,30 L10,25 L15,10 L25,15 L35,5 L45,15 L60,15 L80,25 L95,35 L85,45 L70,40 L60,50 L40,45 L30,55 L20,45 Z M50,25 Q55,20 60,25', w: 100, h: 60, tx: 180, ty: -80 },
                    // Spine: Jagged vertebrae
                    { id: 's-spine', path: 'M10,25 L20,15 L30,25 L40,15 L50,25 L60,15 L70,25 L80,15 L90,25 L100,15 L110,25 L120,15 L130,25 L140,15 L150,25 L160,15 L170,25 L175,35 L170,45 L10,45 Z', w: 180, h: 60, tx: 0, ty: 0 },
                    // Wing L: Arm bone + Fingers
                    { id: 's-wingl', path: 'M90,90 L70,70 L50,80 L40,60 L20,70 L10,50 L30,40 L40,20 L60,30 L80,10 L90,20 L80,40 L95,50 Z', w: 100, h: 100, tx: -80, ty: -50 },
                    // Wing R: Mirror
                    { id: 's-wingr', path: 'M10,90 L30,70 L50,80 L60,60 L80,70 L90,50 L70,40 L60,20 L40,30 L20,10 L10,20 L20,40 L5,50 Z', w: 100, h: 100, tx: 80, ty: -50 },
                    // Tail: Spiked
                    { id: 's-tail', path: 'M10,10 L30,0 L50,15 L70,5 L90,20 L70,35 L50,25 L30,40 L10,30 Z', w: 100, h: 50, tx: 150, ty: 20 },
                ]
            },
            {
                name: "Mûmakil colossus",
                location: "Excavation Site: Harad (The Southlands)",
                desc: "A massive herbivore. The ribcage is dense to support immense weight, and the distinct quadruple-tusk alignment is visible in the cranial fragments.",
                stats: "<span>ERA: Third Age</span><span>TYPE: Oliphaunt</span>",
                imgUrl: "https://i.ytimg.com/vi/JEzuLEjIYSc/maxresdefault.jpg",
                parts: [
                    // Body: Ribcage
                    { id: 'm-body', path: 'M20,30 C40,10 100,10 120,30 L130,80 C100,100 40,100 10,80 Z M30,40 L35,70 M50,40 L55,70 M70,40 L75,70 M90,40 L95,70 M110,40 L115,70', w: 140, h: 90, tx: 0, ty: 0 },
                    // Head: Domed with trunk attachment
                    { id: 'm-head', path: 'M20,40 L25,20 L45,10 L75,20 L80,40 L75,70 L65,90 L45,90 L35,70 Z M65,40 L85,30', w: 90, h: 100, tx: -100, ty: -10 },
                    // Tusks: Curved
                    { id: 'm-tusk', path: 'M60,10 Q40,40 20,80 L30,85 Q50,45 70,20 Z', w: 80, h: 100, tx: -130, ty: 40 },
                    // Leg Front
                    { id: 'm-leg1', path: 'M10,10 L40,10 L45,25 L35,80 L15,80 L5,25 Z', w: 50, h: 90, tx: -50, ty: 80 },
                    // Leg Back
                    { id: 'm-leg2', path: 'M10,10 L40,10 L45,25 L35,80 L15,80 L5,25 Z', w: 50, h: 90, tx: 50, ty: 80 },
                ]
            },
            {
                name: "Pterosaur nazgulii",
                location: "Excavation Site: Minas Morgul",
                desc: "The fell beast. Note the elongated cervical vertebrae allowing for snake-like striking, and the hollow, lightweight construction of the wing digits.",
                stats: "<span>ERA: Second Age</span><span>TYPE: Fell Beast</span>",
                imgUrl: "https://static.wikia.nocookie.net/middle-earth-film-saga/images/1/1a/Fellbeast.png/revision/latest?cb=20161104005132",
                parts: [
                    // Neck: Sinuous
                    { id: 'f-neck', path: 'M10,90 Q30,70 20,50 T50,30 T80,10 L90,20 Q60,40 50,60 T20,90 Z', w: 100, h: 100, tx: -90, ty: -50 },
                    // Skull: Long beak
                    { id: 'f-skull', path: 'M10,30 L60,15 L90,40 L50,50 L40,40 L10,45 Z', w: 100, h: 60, tx: -140, ty: -80 },
                    // Body
                    { id: 'f-body', path: 'M10,20 C30,10 60,10 80,20 L70,50 C50,60 40,60 20,50 Z', w: 90, h: 60, tx: 0, ty: 0 },
                    // Wing L
                    { id: 'f-wingL', path: 'M110,110 L90,90 L70,100 L50,80 L30,90 L10,10 L40,20 L60,10 L90,20 L110,10 Z', w: 120, h: 120, tx: -80, ty: 0 },
                    // Wing R
                    { id: 'f-wingR', path: 'M10,110 L30,90 L50,100 L70,80 L90,90 L110,10 L80,20 L60,10 L30,20 L10,10 Z', w: 120, h: 120, tx: 80, ty: 0 },
                    // Tail
                    { id: 'f-tail', path: 'M10,10 Q50,-10 120,20 L120,30 Q50,0 10,20 Z', w: 130, h: 40, tx: 80, ty: 20 },
                ]
            },
            {
                name: "PROG!!!",
                location: "Excavation Site: The Progressive Pool",
                desc: "A perfectly preserved amphibian from a faraway land. Note the specialized 'spring' mechanism in the hind tibiofibula, suggesting this creature could leap over entire timelines.",
                stats: "<span>ERA: Modern Times?</span><span>TYPE: Amphibian</span>",
                imgUrl: "./assets/prog.jpg",
                parts: [
                    // Skull: Broad and flat with eye sockets
                    { id: 'frog-skull', path: 'M10,30 Q20,5 50,5 Q80,5 90,30 Q95,45 80,55 Q50,65 20,55 Q5,45 10,30 Z M20,30 Q25,20 35,25 M65,25 Q75,20 80,30', w: 100, h: 70, tx: 0, ty: -60 },
                    // Spine & Pelvis: Short spine, distinct V-shape pelvis
                    { id: 'frog-spine', path: 'M45,10 L55,10 L52,40 L75,60 L25,60 L48,40 Z', w: 100, h: 70, tx: 0, ty: 10 },
                    // Front Left Arm: Small and bent
                    { id: 'frog-armL', path: 'M50,10 L30,20 L20,40 M30,20 L10,25', w: 60, h: 50, tx: -40, ty: -20 },
                    // Front Right Arm: Mirror
                    { id: 'frog-armR', path: 'M10,10 L30,20 L40,40 M30,20 L50,25', w: 60, h: 50, tx: 40, ty: -20 },
                    // Hind Leg Left: Big Z-fold jumping leg
                    { id: 'frog-legL', path: 'M90,10 Q50,0 20,30 L10,80 L30,90 M20,30 L40,40', w: 100, h: 100, tx: -60, ty: 50 },
                    // Hind Leg Right: Mirror
                    { id: 'frog-legR', path: 'M10,10 Q50,0 80,30 L90,80 L70,90 M80,30 L60,40', w: 100, h: 100, tx: 60, ty: 50 },
                ]
            }
        ];
        
        // Close welcome modal
        function closeWelcome() {
            document.getElementById('welcome-modal').style.display = 'none';
        }

        // --- STATE ---
        let currentLevelIdx = 0;
        let currentTool = 'brush'; 
        let placedCount = 0;
        let draggedBone = null; 

        // --- DOM REFS ---
        const digSite = document.getElementById('dig-site');
        const museumMount = document.getElementById('museum-mount');
        const plaqueModal = document.getElementById('plaque-modal');
        const brushBtn = document.getElementById('btn-brush');
        const handBtn = document.getElementById('btn-hand');
        let dirtCanvas, ctx;

        // --- INIT ---
        function initLevel(levelIdx) {
            if(digSite.offsetWidth === 0) {
                setTimeout(() => initLevel(levelIdx), 100);
                return;
            }

            // Cleanup
            document.querySelectorAll('.confetti').forEach(c => c.remove());
            document.querySelectorAll('#game-area > .bone').forEach(b => b.remove());

            // Reset
            currentLevelIdx = levelIdx;
            placedCount = 0;
            draggedBone = null;
            digSite.innerHTML = '<div class="label">EXCAVATION ZONE</div>';
            museumMount.innerHTML = '<div class="label">ASSEMBLY MOUNT</div>';
            plaqueModal.style.display = 'none';

            // Data
            const level = levels[levelIdx];
            document.getElementById('level-subtitle').innerText = level.location;

            setupDirt();

            const mountRect = museumMount.getBoundingClientRect();
            const mountCenterX = mountRect.width / 2;
            const mountCenterY = mountRect.height / 2;

            level.parts.forEach(part => {
                // Slot
                const slot = document.createElement('div');
                slot.className = 'bone-slot';
                slot.style.width = part.w + 'px';
                slot.style.height = part.h + 'px';
                slot.style.left = (mountCenterX + part.tx - part.w/2) + 'px';
                slot.style.top = (mountCenterY + part.ty - part.h/2) + 'px';
                slot.innerHTML = `<svg viewBox="0 0 ${part.w} ${part.h}"><path d="${part.path}"/></svg>`;
                museumMount.appendChild(slot);

                // Bone
                const bone = document.createElement('div');
                bone.className = 'bone';
                bone.style.width = part.w + 'px';
                bone.style.height = part.h + 'px';
                bone.innerHTML = `<svg viewBox="0 0 ${part.w} ${part.h}"><path d="${part.path}"/></svg>`;
                
                const maxL = Math.max(10, digSite.offsetWidth - part.w - 20);
                const maxT = Math.max(10, digSite.offsetHeight - part.h - 20);
                
                bone.style.left = (Math.random() * maxL + 10) + 'px';
                bone.style.top = (Math.random() * maxT + 10) + 'px';
                
                const startRot = Math.random() * 360;
                bone.dataset.rotation = startRot; 
                bone.style.transform = `rotate(${startRot}deg)`;

                digSite.appendChild(bone);
                makeDraggable(bone, part, slot);
            });
        }

        // --- DIRT CANVAS ---
        function setupDirt() {
            const oldCanvas = document.getElementById('dirt-canvas');
            if(oldCanvas) oldCanvas.remove();
            
            dirtCanvas = document.createElement('canvas');
            dirtCanvas.id = 'dirt-canvas';
            
            const rect = digSite.getBoundingClientRect();
            dirtCanvas.width = rect.width;
            dirtCanvas.height = rect.height;
            
            digSite.appendChild(dirtCanvas); 

            ctx = dirtCanvas.getContext('2d');
            
            // Fill
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillStyle = '#8b5a2b'; 
            ctx.fillRect(0, 0, dirtCanvas.width, dirtCanvas.height);
            
            // Texture
            for(let i=0; i<500; i++) {
                ctx.fillStyle = Math.random() > 0.5 ? '#6b4220' : '#a06e3d';
                ctx.beginPath();
                ctx.arc(Math.random()*dirtCanvas.width, Math.random()*dirtCanvas.height, Math.random()*3+1, 0, Math.PI*2);
                ctx.fill();
            }

            let isBrushing = false;

            const startBrush = (e) => {
                if (currentTool !== 'brush') return;
                isBrushing = true;
                brush(e);
            };
            const moveBrush = (e) => {
                if (!isBrushing || currentTool !== 'brush') return;
                brush(e);
            };
            const endBrush = () => isBrushing = false;

            const brush = (e) => {
                const rect = dirtCanvas.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

                ctx.globalCompositeOperation = 'destination-out';
                ctx.beginPath();
                ctx.arc(x, y, 30, 0, Math.PI * 2); 
                ctx.fill();
            };

            dirtCanvas.onmousedown = startBrush;
            dirtCanvas.onmousemove = moveBrush;
            document.onmouseup = endBrush;
            dirtCanvas.ontouchstart = startBrush;
            dirtCanvas.ontouchmove = moveBrush;
            document.ontouchend = endBrush;
        }

        function setTool(tool) {
            currentTool = tool;
            if (tool === 'brush') {
                brushBtn.classList.add('active');
                handBtn.classList.remove('active');
                digSite.classList.add('tool-brush');
                digSite.classList.remove('tool-hand');
            } else {
                handBtn.classList.add('active');
                brushBtn.classList.remove('active');
                digSite.classList.add('tool-hand');
                digSite.classList.remove('tool-brush');
            }
        }

        // --- DRAG/DROP ---
        function makeDraggable(el, partData, targetEl) {
            let startX, startY, initialLeft, initialTop;

            const onMove = (e) => {
                if (draggedBone !== el) return;
                e.preventDefault();
                
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                const dx = clientX - startX;
                const dy = clientY - startY;

                el.style.left = (initialLeft + dx) + 'px';
                el.style.top = (initialTop + dy) + 'px';
            };

            const onEnd = () => {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchmove', onMove);
                document.removeEventListener('touchend', onEnd);

                if (draggedBone !== el) return;
                
                let currentRot = parseFloat(el.dataset.rotation);
                updateTransform(el, currentRot, 1.0);
                
                checkSnap(el, targetEl);
                draggedBone = null;
            };

            const onStart = (e) => {
                if (currentTool !== 'hand') return; 
                if (el.classList.contains('placed')) return;

                draggedBone = el; 
                
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                
                const rect = el.getBoundingClientRect();
                const gameRect = document.getElementById('game-area').getBoundingClientRect();
                
                if (el.parentElement === digSite) {
                    document.getElementById('game-area').appendChild(el);
                    el.style.left = (rect.left - gameRect.left) + 'px';
                    el.style.top = (rect.top - gameRect.top) + 'px';
                }

                startX = clientX;
                startY = clientY;
                initialLeft = parseFloat(el.style.left);
                initialTop = parseFloat(el.style.top);
                
                updateTransform(el, parseFloat(el.dataset.rotation), 1.1);
                
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onEnd);
                document.addEventListener('touchmove', onMove, {passive: false});
                document.addEventListener('touchend', onEnd);
            };

            el.addEventListener('mousedown', onStart);
            el.addEventListener('touchstart', onStart, {passive: false});
        }

        window.addEventListener('keydown', (e) => {
            if (!draggedBone) return;
            let rot = parseFloat(draggedBone.dataset.rotation);
            if (e.key === 'a' || e.key === 'ArrowLeft') rot -= 5;
            if (e.key === 'd' || e.key === 'ArrowRight') rot += 5;
            draggedBone.dataset.rotation = rot;
            updateTransform(draggedBone, rot, 1.1);
        });

        window.addEventListener('wheel', (e) => {
            if (!draggedBone) return;
            let rot = parseFloat(draggedBone.dataset.rotation);
            rot += (e.deltaY > 0 ? 5 : -5);
            draggedBone.dataset.rotation = rot;
            updateTransform(draggedBone, rot, 1.1);
        });

        function updateTransform(el, rot, scale) {
            el.style.transform = `rotate(${rot}deg) scale(${scale})`;
        }

        function checkSnap(bone, targetSlot) {
            const bRect = bone.getBoundingClientRect();
            const tRect = targetSlot.getBoundingClientRect();

            const bCX = bRect.left + bRect.width/2;
            const bCY = bRect.top + bRect.height/2;
            const tCX = tRect.left + tRect.width/2;
            const tCY = tRect.top + tRect.height/2;
            const dist = Math.hypot(bCX - tCX, bCY - tCY);

            let rot = parseFloat(bone.dataset.rotation) % 360;
            if (rot < 0) rot += 360;
            const rotDiff = Math.min(rot, 360 - rot);

            if (dist < 50 && rotDiff < 15) {
                const gameRect = document.getElementById('game-area').getBoundingClientRect();
                bone.style.left = (tRect.left - gameRect.left) + 'px';
                bone.style.top = (tRect.top - gameRect.top) + 'px';
                bone.style.transform = 'rotate(0deg)';
                bone.classList.add('placed');
                bone.style.cursor = 'default';
                
                placedCount++;
                if (placedCount === levels[currentLevelIdx].parts.length) {
                    setTimeout(showWin, 500);
                }
            }
        }

        function showWin() {
            const level = levels[currentLevelIdx];
            document.getElementById('plaque-title').innerText = level.name;
            document.getElementById('plaque-desc').innerText = level.desc;
            document.getElementById('plaque-stats').innerHTML = level.stats;
            document.getElementById('creature-image').src = level.imgUrl;
            
            const container = document.getElementById('skeleton-3d-container');
            container.innerHTML = ''; 
            
            level.parts.forEach(part => {
                const bone = document.createElement('div');
                bone.className = 'modal-bone';
                
                const s = 0.7;
                bone.style.width = (part.w * s) + 'px';
                bone.style.height = (part.h * s) + 'px';
                
                const left = 100 + (part.tx * s) - (part.w * s / 2);
                const top = 100 + (part.ty * s) - (part.h * s / 2);
                
                bone.style.left = left + 'px';
                bone.style.top = top + 'px';
                
                bone.innerHTML = `<svg viewBox="0 0 ${part.w} ${part.h}"><path d="${part.path}"/></svg>`;
                container.appendChild(bone);
            });
            
            const btn = document.getElementById('next-level-btn');
            
            // 1. If we are currently on the last level -> Restart
            if (currentLevelIdx >= levels.length - 1) {
                btn.innerText = "Restart Exhibition";
            } 
            // 2. If the NEXT level is Señor Prog 
            else if (levels[currentLevelIdx + 1].name.includes("PROG")) {
                btn.innerText = "Excavate BONUS ROUND!";
            } 
            // 3. Otherwise -> Standard Text
            else {
                btn.innerText = "Excavate Next Specimen";
            }
            
            plaqueModal.style.display = 'flex';
            fireConfetti();
        }

        function nextLevel() {
            if (currentLevelIdx < levels.length - 1) {
                initLevel(currentLevelIdx + 1);
            } else {
                initLevel(0);
            }
        }

        function fireConfetti() {
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff'];
            for(let i=0; i<50; i++) {
                const conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.top = '-10px';
                conf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                conf.style.animationDuration = (Math.random() * 3 + 2) + 's';
                document.body.appendChild(conf);
            }
        }

        window.addEventListener('load', () => {
             initLevel(0);
        });
        
        window.addEventListener('resize', () => {
            clearTimeout(window.resizeTimer);
            window.resizeTimer = setTimeout(() => {
                initLevel(currentLevelIdx);
            }, 200);
        });

    </script>
</body>
</html>
